<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Reservas Taller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- NUEVOS COLORES CLAROS (Light Gray/White con acentos Azules) --- */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; /* Fondo Gris Muy Claro */
            min-height: 100vh; 
            color: #1f2937; /* Texto principal oscuro */
        } 
        .card { 
            background-color: white; /* Fondo blanco */
            border: 1px solid #e5e7eb; /* Borde suave */
            border-radius: 0.75rem; 
            color: #1f2937; /* Texto principal oscuro */
        } /* Tarjeta Blanca */
        .btn-primary { 
            background-color: #3b82f6; /* Azul Primario */
            transition: all 0.3s ease; 
        }
        .btn-primary:hover { 
            background-color: #2563eb; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.5); 
        }
        .input-style { 
            background-color: white; /* Fondo de input blanco */
            color: #1f2937; /* Texto de input oscuro */
            border: 1px solid #d1d5db; /* Borde gris */
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Sombra ligera */
        }
        /* Convertir texto a may칰sculas para que sea visible en el input */
        .input-style { text-transform: uppercase; } 
        
        .input-style:focus { 
            background-color: white; 
            outline: none; 
            border-color: #3b82f6; /* Borde Azul en foco */
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .text-primary-color { color: #3b82f6; } /* Color de acento Azul */
        .form-radio { color: #3b82f6; border-color: #d1d5db; }

        /* Ajustes para el texto dentro del contexto de la tarjeta blanca */
        .text-gray-300 { color: #4b5563; /* Hacer el texto m치s oscuro para contraste */ }
        .text-gray-400 { color: #6b7280; /* Hacer el texto m치s oscuro para contraste */ }
        .border-gray-500 { border-color: #e5e7eb; } /* Borde m치s claro */
        .bg-gray-600 { background-color: #e5e7eb; color: #4b5563; } /* Estado de conexi칩n m치s visible */
        .bg-green-700 { background-color: #10b981; } /* Mantener colores de estado de conexi칩n fuertes */
        .bg-red-700 { background-color: #ef4444; }
        .bg-yellow-600 { background-color: #f59e0b; }
        /* ---------------------------------------------------- */
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center">

    <div class="max-w-4xl w-full card p-6 sm:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl sm:text-4xl font-extrabold mb-2 text-center text-primary-color">
            Reserva de Servicio - Taller
        </h1>
        
        <div id="connection-status" class="text-center p-3 mb-6 rounded-lg font-semibold bg-gray-600">
            Verificando conexi칩n y configuraci칩n...
        </div>

        <p class="text-center text-gray-300 mb-8">
            Agenda tu mantenimiento o garant칤a con 48 horas de anticipaci칩n.
        </p>

        <!-- Contenedor de Alertas -->
        <div id="alert-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

        <form id="reservation-form" class="space-y-6">
            <h2 class="text-xl font-semibold border-b border-gray-500 pb-2 text-primary-color">Datos de la Moto y el Cliente</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Se ha a침adido la clase input-style para may칰sculas autom치ticas en JS -->
                <input type="text" id="nombre" placeholder="NOMBRE COMPLETO *" class="input-style p-3 rounded-lg" required>
                <input type="tel" id="telefono" placeholder="TEL칄FONO (9 D칈GITOS) *" class="input-style p-3 rounded-lg" required pattern="[0-9]{9}" title="Debe tener 9 d칤gitos num칠ricos">
                <input type="email" id="email" placeholder="CORREO ELECTR칍NICO (OPCIONAL)" class="input-style p-3 rounded-lg">
                <input type="text" id="placa" placeholder="PLACA DE LA MOTOCICLETA *" class="input-style p-3 rounded-lg" required>
                <input type="text" id="marca" placeholder="MARCA DE LA MOTOCICLETA *" class="input-style p-3 rounded-lg" required>
                <input type="text" id="modelo" placeholder="MODELO DE LA MOTOCICLETA *" class="input-style p-3 rounded-lg" required>
                <input type="number" id="kilometraje" placeholder="KILOMETRAJE (km) *" class="input-style p-3 rounded-lg" required min="1">
            </div>

            <h2 class="text-xl font-semibold border-b border-gray-500 pb-2 text-primary-color">Selecci칩n de Servicio</h2>

            <div class="flex space-x-4">
                <label class="flex items-center text-lg">
                    <input type="radio" name="service-type" value="Mantenimiento" class="form-radio h-4 w-4 text-primary-color border-gray-300" checked>
                    <span class="ml-2">Mantenimiento</span>
                </label>
                <label class="flex items-center text-lg">
                    <input type="radio" name="service-type" value="Garantia" class="form-radio h-4 w-4 text-primary-color border-gray-300">
                    <span class="ml-2">Garant칤a</span>
                </label>
            </div>

            <div id="maintenance-selector" class="mt-4">
                <select id="mantenimiento-tipo" class="input-style w-full p-3 rounded-lg">
                    <option value="1춿" data-duration="0.5">1춿 Mantenimiento (B치sico)</option>
                    <option value="2춿" data-duration="0.5">2춿 Mantenimiento (B치sico)</option>
                    <option value="3춿" data-duration="0.5">3춿 Mantenimiento (B치sico)</option>
                    <option value="4춿" data-duration="3">4춿 Mantenimiento (General)</option>
                    <option value="5춿" data-duration="3">5춿 Mantenimiento (General)</option>
                    <option value="6춿" data-duration="3">6춿 Mantenimiento (General)</option>
                    <option value="7춿" data-duration="3">7춿 Mantenimiento (General)</option>
                    <option value="8춿" data-duration="3">8춿 Mantenimiento (General)</option>
                </select>
            </div>

            <h2 class="text-xl font-semibold border-b border-gray-500 pb-2 text-primary-color">Fecha y Horario</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="date" id="fecha-cita" class="input-style p-3 rounded-lg" required>
                <select id="mecanico-select" class="input-style p-3 rounded-lg" required>
                    <option value="">Selecciona Mec치nico</option>
                </select>
                <select id="hora-select" class="input-style p-3 rounded-lg" required disabled>
                    <option value="">Selecciona Hora</option>
                </select>
            </div>
            <p id="date-info" class="text-sm text-gray-400 mt-2 italic"></p>
            <p id="availability-status" class="text-sm text-red-500 mt-2 font-bold"></p>


            <textarea id="observaciones" placeholder="OBSERVACIONES Y DIAGN칍STICO (OBLIGATORIO) *" rows="3" class="input-style w-full p-3 rounded-lg" required></textarea>

            <button type="submit" class="btn-primary w-full p-4 text-xl font-bold rounded-lg shadow-lg">
                Confirmar Reserva
            </button>
        </form>
    </div>

    <script>
        // =======================================================================================
        // 游뚿 URL DE TU DESPLIEGUE DE GOOGLE APPS SCRIPT (ACTUALIZADA)
        // =======================================================================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbwoz6z9x4wWIMM_8i_yrhY4x__x3HVVI_KEYtbpDVy0aWuWCb114Wfs4W_c1F9TOzrS/exec';
        // =======================================================================================

        // Referencias del DOM
        const form = document.getElementById('reservation-form');
        const alertContainer = document.getElementById('alert-container');
        const connectionStatusDiv = document.getElementById('connection-status'); 
        const serviceRadios = document.querySelectorAll('input[name="service-type"]');
        const maintenanceSelector = document.getElementById('maintenance-selector');
        const mantenimientoTipo = document.getElementById('mantenimiento-tipo');
        const fechaCitaInput = document.getElementById('fecha-cita');
        const mecanicoSelect = document.getElementById('mecanico-select');
        const horaSelect = document.getElementById('hora-select');
        const observacionesTextarea = document.getElementById('observaciones');
        const availabilityStatus = document.getElementById('availability-status');
        const dateInfo = document.getElementById('date-info');

        // Variables de Estado
        let config = {
            advanceBookingHours: 48, 
            guaranteeDay: 3, 
            workingDays: [1, 2, 3, 4, 5, 6],
            generalMaintenanceDuration: 3 
        };
        let mechanics = [];
        let currentDuration = 0.5; 

        // --- Utilidades de UI ---

        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            const color = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? '&#10003;' : '&#9888;';
            
            alertDiv.className = `${color} text-white p-3 rounded-lg shadow-xl flex items-center transition-opacity duration-300`;
            alertDiv.innerHTML = `<span class="mr-2 text-xl">${icon}</span><span>${message}</span>`;
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.classList.add('opacity-0');
                alertDiv.addEventListener('transitionend', () => alertDiv.remove());
            }, 5000);
        }
        
        function updateConnectionStatus(message, type) {
            // Se usa el color de texto oscuro para los fondos claros en la nueva paleta
            let colorClass = 'bg-gray-200 text-gray-800'; // Nuevo color claro
            if (type === 'success') colorClass = 'bg-green-600 text-white';
            else if (type === 'error') colorClass = 'bg-red-600 text-white';
            else if (type === 'warning') colorClass = 'bg-yellow-500 text-gray-900';

            connectionStatusDiv.className = `text-center p-3 mb-6 rounded-lg font-semibold ${colorClass}`;
            connectionStatusDiv.textContent = message;
        }

        /**
         * Configura los campos de texto para convertir autom치ticamente a may칰sculas.
         */
        function setupUppercaseInputs() {
            const fieldsToUppercase = ['nombre', 'placa', 'marca', 'modelo', 'observaciones'];
            
            fieldsToUppercase.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', (e) => {
                        // Forzar el valor a may칰sculas en cada pulsaci칩n de tecla
                        e.target.value = e.target.value.toUpperCase();
                    });
                }
            });
        }
        
        /**
         * Maneja la l칩gica de validaci칩n de fechas (m칤nimo 48h, d칤a de garant칤a).
         */
        function validateDate(dateStr, serviceType) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const selectedDate = new Date(dateStr + 'T00:00:00'); 
            const timeDiff = selectedDate.getTime() - today.getTime();
            const hoursDiff = timeDiff / (1000 * 3600);

            const minAdvanceHours = parseInt(config.advanceBookingHours) || 48;
            const guaranteeDay = parseInt(config.guaranteeDay) || 3; 

            if (hoursDiff < minAdvanceHours) {
                return `Debe reservar con una anticipaci칩n m칤nima de ${minAdvanceHours} horas.`;
            }

            const dayOfWeek = selectedDate.getDay();
            const isWorkingDay = (config.workingDays || [1, 2, 3, 4, 5, 6]).includes(dayOfWeek);
            const isGuaranteeDay = dayOfWeek === guaranteeDay;

            if (!isWorkingDay && !isGuaranteeDay) {
                return 'D칤a no laboral. Solo trabajamos de Lunes a S치bado.';
            }

            if (serviceType === 'Garantia' && !isGuaranteeDay) {
                return `El servicio de Garant칤a solo est치 disponible los Mi칠rcoles.`;
            }
            if (serviceType === 'Mantenimiento' && isGuaranteeDay) {
                return `El d칤a Mi칠rcoles est치 reservado exclusivamente para servicios de Garant칤a.`;
            }

            return null;
        }


        /**
         * Carga la configuraci칩n inicial y los mec치nicos.
         */
        async function loadInitialData() {
            updateConnectionStatus('Verificando conexi칩n y cargando datos...', 'warning');
            
            try {
                const url = new URL(API_URL);
                url.searchParams.append('action', 'getInitialData'); 

                const response = await fetch(url.toString());
                const data = await response.json();

                if (data.status === 'ERROR') {
                    const message = data.message || 'Error desconocido del Apps Script.';
                    showAlert(`Error al cargar datos iniciales: ${message}`, 'error');
                    updateConnectionStatus(`ERROR (Servidor): ${message}`, 'error');
                    console.error("Apps Script Error:", message);
                    // No hacer return aqu칤 para poder ejecutar el resto del c칩digo y ver qu칠 falla.
                    return;
                }

                config = data.config || config; 
                mechanics = data.mechanics || [];
                
                // Rellenar select de mec치nicos
                mecanicoSelect.innerHTML = '<option value="">Selecciona Mec치nico</option>';
                mechanics.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.ID;
                    option.textContent = m.Nombre;
                    mecanicoSelect.appendChild(option);
                });

                // Establecer fecha m칤nima
                const minAdvanceHours = parseInt(config.advanceBookingHours) || 48;
                const minDate = new Date();
                minDate.setHours(minDate.getHours() + minAdvanceHours); 
                fechaCitaInput.min = minDate.toISOString().split('T')[0];
                
                updateConnectionStatus('Conexi칩n Exitosa. Configuraci칩n y Mec치nicos cargados.', 'success');
                console.log("Mec치nicos recibidos (Debe ser una lista de objetos):", mechanics);
                
            } catch (error) {
                console.error("Error de conexi칩n al Apps Script:", error);
                const message = 'Fallo de red. Revisa la URL de tu Apps Script o el despliegue.';
                showAlert(message, 'error');
                updateConnectionStatus(`ERROR (Red): ${message}`, 'error');
            }
        }
        
        /**
         * Obtiene y muestra los slots disponibles.
         */
        async function getAndDisplaySlots() {
            const fechaCita = fechaCitaInput.value;
            const mecanicoId = mecanicoSelect.value;
            const serviceType = document.querySelector('input[name="service-type"]:checked').value;

            horaSelect.innerHTML = '<option value="">Cargando horas...</option>';
            horaSelect.disabled = true;
            availabilityStatus.textContent = '';
            
            if (!fechaCita || !mecanicoId) return;

            const validationError = validateDate(fechaCita, serviceType);
            if (validationError) {
                availabilityStatus.textContent = validationError;
                horaSelect.innerHTML = '<option value="">Selecciona Hora</option>';
                return;
            }

            // Usar la configuraci칩n cargada
            const generalDuration = parseFloat(config.generalMaintenanceDuration) || 3; 

            // Determinar si es un mantenimiento 'General' (4춿 en adelante)
            const isGeneralMaintenance = serviceType === 'Mantenimiento' && 
                                         mantenimientoTipo.value && 
                                         (parseInt(mantenimientoTipo.value.charAt(0)) >= 4);

            
            // L칩gica para determinar currentDuration (ajustada para ser m치s expl칤cita)
            if (serviceType === 'Garantia') {
                // Si el script de Apps Script usa 'guaranteeDuration' en config.
                currentDuration = parseFloat(config.guaranteeDuration) || 1.5; 
            } else if (isGeneralMaintenance) {
                // Mantenimiento 4춿 en adelante
                currentDuration = generalDuration;
            } else {
                // Mantenimiento 1춿, 2춿, 3춿
                currentDuration = parseFloat(config.basicMaintenanceDuration) || 0.5;
            }
            
            dateInfo.textContent = `Duraci칩n estimada del servicio: ${currentDuration} horas.`;


            try {
                const url = new URL(API_URL);
                url.searchParams.append('action', 'getAvailableSlots');
                url.searchParams.append('date', fechaCita);
                url.searchParams.append('mechanicId', mecanicoId);
                url.searchParams.append('serviceType', serviceType);
                url.searchParams.append('duration', currentDuration);

                const response = await fetch(url.toString());
                const data = await response.json();

                if (data.status === 'ERROR') {
                    availabilityStatus.textContent = `Error del servidor: ${data.message}`;
                    // Enviar a consola el mensaje para facilitar el debug
                    console.error("Error en getAvailableSlots:", data.message);
                    return;
                }
                
                const slots = data.slots || [];
                horaSelect.innerHTML = '<option value="">Selecciona Hora</option>';
                
                if (slots.length > 0) {
                    slots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot.time;
                        option.textContent = `${slot.time} - ${slot.endTime}`;
                        horaSelect.appendChild(option);
                    });
                    horaSelect.disabled = false;
                    availabilityStatus.textContent = '';
                } else {
                    availabilityStatus.textContent = 'No hay horarios disponibles para esta selecci칩n.';
                    horaSelect.disabled = true;
                }

            } catch (error) {
                console.error("Error al obtener slots:", error);
                showAlert('Fallo al obtener disponibilidad. Revise la consola.', 'error');
                horaSelect.innerHTML = '<option value="">Selecciona Hora</option>';
            }
        }

        /**
         * Env칤a la reserva al Apps Script (POST).
         */
        async function sendReservation(formData) {
            const button = form.querySelector('button[type="submit"]');
            button.disabled = true;
            button.textContent = 'Procesando Reserva...';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'cors', 
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                // --- MECANISMO DE DIAGN칍STICO A칌ADIDO ---
                const responseText = await response.text();
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (e) {
                    console.error("Error al parsear JSON (Apps Script devolvi칩 texto):", e);
                    // Si falla al parsear, significa que Apps Script devolvi칩 algo que no es JSON (ej. HTML de error)
                    showAlert('Error en el Apps Script (Devolvi칩 formato incorrecto). Revise el registro de ejecuci칩n de doPost.', 'error');
                    console.error("Respuesta cruda del Apps Script (NO JSON):", responseText);
                    return;
                }
                // ----------------------------------------

                if (data.status === 'SUCCESS') {
                    showAlert('춰Reserva confirmada! Te contactaremos pronto para confirmar los detalles.');
                    form.reset(); 
                    horaSelect.innerHTML = '<option value="">Selecciona Hora</option>';
                    horaSelect.disabled = true;
                    availabilityStatus.textContent = '';
                } else {
                    showAlert(`Error al reservar: ${data.message}`, 'error');
                }

            } catch (error) {
                // Este 'catch' solo se activa por fallas de red (Failed to fetch) o CORS
                console.error("Error de conexi칩n al reservar (Failed to fetch/CORS):", error);
                showAlert('Error de red. El servidor no respondi칩. Revise la configuraci칩n de ACCESO de su despliegue (Debe ser "Cualquier persona").', 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Confirmar Reserva';
            }
        }

        // --- Event Listeners y L칩gica ---

        serviceRadios.forEach(radio => radio.addEventListener('change', () => {
            const serviceType = document.querySelector('input[name="service-type"]:checked').value;
            maintenanceSelector.style.display = serviceType === 'Mantenimiento' ? 'block' : 'none';
            getAndDisplaySlots();
        }));

        mantenimientoTipo.addEventListener('change', getAndDisplaySlots);
        fechaCitaInput.addEventListener('change', getAndDisplaySlots);
        mecanicoSelect.addEventListener('change', getAndDisplaySlots);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // 1. Validaciones
            if (document.getElementById('telefono').value.length !== 9) {
                showAlert('El tel칠fono debe tener exactamente 9 d칤gitos.', 'error');
                return;
            }
            const serviceType = document.querySelector('input[name="service-type"]:checked').value;
            if (validateDate(fechaCitaInput.value, serviceType)) {
                 showAlert(validateDate(fechaCitaInput.value, serviceType), 'error');
                return;
            }
            
            // 2. Recolecci칩n de datos
            const selectedMechanic = mechanics.find(m => m.ID === mecanicoSelect.value);

            const formData = {
                action: 'createReservation',
                // Los datos ya est치n en may칰sculas gracias a setupUppercaseInputs()
                nombre: document.getElementById('nombre').value,
                telefono: document.getElementById('telefono').value,
                email: document.getElementById('email').value || 'N/A',
                placa: document.getElementById('placa').value,
                marca: document.getElementById('marca').value,
                modelo: document.getElementById('modelo').value,
                kilometraje: document.getElementById('kilometraje').value,
                tipoServicio: serviceType,
                categoriaServicio: serviceType === 'Mantenimiento' ? mantenimientoTipo.value : 'Garant칤a',
                descripcionServicio: serviceType === 'Mantenimiento' ? `MANTENIMIENTO ${mantenimientoTipo.value}` : 'DIAGN칍STICO DE GARANT칈A',
                fechaCita: fechaCitaInput.value,
                hora: horaSelect.value,
                mecanicoId: mecanicoSelect.value,
                mecanico: selectedMechanic ? selectedMechanic.Nombre : 'ERROR',
                observaciones: observacionesTextarea.value,
                duracion: currentDuration
            };
            
            await sendReservation(formData);
        });

        // Cargar datos al inicio y configurar may칰sculas
        loadInitialData();
        setupUppercaseInputs();
        
        // Funci칩n de debug global para Rodolfo
        window.mechanics = mechanics; 
        
    </script>
</body>
</html>
